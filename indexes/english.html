<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SAT English (Reading & Writing)</title>
  <style>
    :root{
      --bg:#0f1320; --bg-2:#101626;
      --surface:rgba(255,255,255,.06); --surface-strong:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.12); --border:rgba(255,255,255,.18);
      --text:#eef3ff; --muted:#b8c2e6;
      --accent:#74a3ff; --accent-2:#66e6d2;
      --green:#35d49f; --red:#ff6b7c; --yellow:#ffd166;
      --radius-sm:10px; --radius-md:14px; --radius-lg:18px;
      --shadow-1:0 6px 20px rgba(0,0,0,.25); --shadow-2:0 14px 40px rgba(0,0,0,.35);
      --blur:14px; --speed-fast:.15s; --speed:.25s;
      --font:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; color:var(--text); font-family:var(--font);
      background:
        radial-gradient(1000px 1000px at 10% -10%, #1a2240, transparent 60%),
        radial-gradient(1400px 800px at 100% 10%, #18244a, transparent 40%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      overflow:hidden;
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.35; z-index:0;
      background-image:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.14) 50%, transparent 51%),
        radial-gradient(2px 2px at 70% 30%, rgba(255,255,255,.09) 50%, transparent 51%),
        radial-gradient(2px 2px at 30% 80%, rgba(255,255,255,.07) 50%, transparent 51%),
        radial-gradient(2px 2px at 80% 60%, rgba(255,255,255,.10) 50%, transparent 51%);
    }
    .warning{
      position:fixed; right:12px; bottom:12px; z-index:9999; pointer-events:none;
      color:var(--yellow); font-size:14px; opacity:.9;
      background:var(--surface); border:1px solid var(--border); border-radius:10px;
      padding:8px 12px; backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow-1);
    }
    #app{ display:none; }
    .directions{
      width:min(1120px,92%); height:100vh; margin:0 auto; overflow:auto;
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg);
      box-shadow:var(--shadow-2); backdrop-filter:blur(var(--blur));
    }
    .dir-top{
      position:sticky; top:0; z-index:2; display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:14px 18px; background:var(--surface-strong); border-bottom:1px solid var(--border);
      border-top-left-radius:var(--radius-lg); border-top-right-radius:var(--radius-lg);
    }
    .dir-top h2{ margin:0; font-size:22px; }
    .dir-body{ width:min(900px,90%); margin:16px auto 24px; padding-bottom:16px; }
    .dir-body h1{ margin:6px 0 10px; font-size:30px; font-weight:900; }
    .dir-body p{ color:var(--muted); line-height:1.7; font-size:18px; }
    .btn{
      height:46px; min-width:170px; padding:0 20px; font-weight:900; letter-spacing:.2px; border:0; border-radius:14px;
      background:linear-gradient(180deg,#6ea3ff 0%, #4b82ff 100%); color:#fff; cursor:pointer;
      box-shadow:0 10px 22px rgba(76,130,255,.22), inset 0 1px 0 rgba(255,255,255,.4);
      transition:transform var(--speed-fast);
    }
    .btn:hover{ transform:translateY(-1px) }
    #reading-container{
      width:min(1200px,94%); height:100vh; margin:0 auto; display:none; flex-direction:column; overflow:hidden;
    }
    .topLay{
      flex:0 0 auto; position:sticky; top:10px; z-index:9; gap:16px; display:flex; align-items:center; justify-content:space-between;
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg);
      padding:10px 12px; backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow-1);
    }
    .mention-section{ font-size:18px; font-weight:800; letter-spacing:.3px; opacity:.95 }
    .q-counter{ font-size:14px; font-weight:900; letter-spacing:.4px; color:var(--muted) }
    #navigation{ display:flex; gap:10px; align-items:center }
    #navigation button{
      background:linear-gradient(180deg,#6ea3ff 0%, #4b82ff 100%); color:#fff; border:1px solid rgba(255,255,255,.25);
      border-radius:12px; height:40px; min-width:100px; font-weight:800; cursor:pointer;
      box-shadow:0 10px 20px rgba(76,130,255,.20), inset 0 1px 0 rgba(255,255,255,.5);
    }
    #timer{ font-size:18px; font-weight:800; color:#dbe6ff; text-shadow:0 0 18px rgba(116,163,255,.35) }
    #layout{
      flex:1 1 auto; min-height:0; overflow:hidden; display:grid; grid-template-columns:1.2fr .8fr; gap:26px; margin-top:12px;
    }
    #passage-section{
      border:1px solid var(--border); border-radius:var(--radius-lg);
      background:var(--surface); box-shadow:var(--shadow-2); padding:16px 18px; overflow:hidden;
    }
    #passage-title{ font-size:20px; font-weight:800; margin:0 0 8px; }
    #scrollable-passage{ max-height:calc(100vh - 260px); overflow:auto; padding-right:6px; }
    #scrollable-passage p{ line-height:1.7; font-size:16px; color:var(--text); }
    #scrollable-passage .split{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    #question-section{
      position:sticky; top:70px; align-self:start; max-height:calc(100vh - 120px);
      overflow:auto; border:1px solid var(--border); border-radius:var(--radius-lg);
      background:var(--surface); box-shadow:var(--shadow-2); padding:12px;
    }
    .q-block{ border:1px solid var(--border); border-radius:var(--radius-md); background:var(--card); padding:16px; margin-top:12px; box-shadow:var(--shadow-1); }
    .q-title{ margin:0 0 10px; font-size:18px; font-weight:800; }
    .q-meta{ font-size:12px; color:var(--muted); margin-bottom:8px; }
    .options{ list-style:none; margin:0; padding:0; }
    .options li{
      margin:10px 0; padding:12px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.04);
      cursor:pointer; transition:background var(--speed), transform var(--speed-fast), box-shadow var(--speed);
      box-shadow:0 1px 0 rgba(255,255,255,.06);
    }
    .options li:hover{ background:rgba(116,163,255,.10); transform:translateY(-1px); box-shadow:0 8px 18px rgba(116,163,255,.14); }
    .options li.selected{ background:rgba(116,163,255,.18); border-color:rgba(116,163,255,.55); box-shadow:0 0 0 3px rgba(116,163,255,.22) inset, 0 8px 22px rgba(116,163,255,.18); }
    table.data{ width:100%; border-collapse:collapse; margin-top:10px; }
    .data th,.data td{ border:1px solid rgba(255,255,255,.10); padding:8px 10px; text-align:center; color:var(--text); }
    .data th{ background:linear-gradient(180deg, rgba(116,163,255,.18), rgba(116,163,255,.10)); }
    .overlay{
      display:none; width:min(900px,92%); margin:30px auto; background:var(--surface);
      border:1px solid var(--border); border-radius:var(--radius-lg); box-shadow:var(--shadow-2);
      padding:18px; text-align:center;
    }
    .overlay h2{ margin:10px 0; }
    #final{
      display:none; width:min(1100px,94%); max-height:100vh; margin:24px auto; overflow:auto;
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg);
      box-shadow:var(--shadow-2); padding:20px;
    }
    @media (max-width: 980px){
      #layout{ grid-template-columns:1fr }
      #question-section{ position:relative; top:0; max-height:none }
      #scrollable-passage{ max-height:none }
    }
  </style>
</head>
<body>
  <p class="warning">If you leave the test, switch tabs, or close the tab, the test will automatically reset!</p>

  <div id="app">
    <div id="dirReading" class="directions" style="display:none;">
      <div class="dir-top">
        <h2>Directions — Reading</h2>
        <button class="btn" id="toWritingBtn">Continue</button>
      </div>
      <div class="dir-body">
        <h1>Reading directions</h1>
        <p>Each question has a short text on the left and one question on the right. Read the text and choose the best answer.</p>
      </div>
    </div>

    <div id="dirWriting" class="directions" style="display:none;">
      <div class="dir-top">
        <h2>Directions — Writing</h2>
        <button class="btn" id="startEnglishBtn">Start English</button>
      </div>
      <div class="dir-body">
        <h1>Writing directions</h1>
        <p>Some questions ask you to revise for clarity, logic, or grammar. Choose the option that best improves the text.</p>
        <p>English is delivered in two modules, 32 minutes each. A timer shows the remaining time for the current module.</p>
      </div>
    </div>

    <div id="moduleBreak" class="overlay">
      <h2>End of Module 1</h2>
      <p>Your answers are recorded. When you’re ready, start Module 2 (32:00).</p>
      <button class="btn" id="startModule2Btn">Start Module 2</button>
    </div>

    <div id="reading-container">
      <div class="topLay">
        <p class="mention-section" id="moduleLabel">SAT English — Module 1</p>
        <div class="q-counter" id="qCounter">Question 1 of 1</div>
        <div id="navigation">
          <button id="prevBtn">Back</button>
          <div id="timer">Time Left: 32:00</div>
          <button id="nextBtn">Next</button>
        </div>
      </div>

      <div id="layout">
        <div id="passage-section">
          <h2 id="passage-title">Passage</h2>
          <div id="scrollable-passage"><div id="passage-text"></div></div>
        </div>
        <div id="question-section">
          <div id="question-container"></div>
        </div>
      </div>
    </div>

    <div id="final">
      <h2>Scoring…</h2>
      <p>Your English results have been saved.</p>
      <p>If Math was selected, you’ll go there next; otherwise we’ll open the results page.</p>
    </div>
  </div>

  <script>
    const MODULE_SECONDS_DEFAULT = 32 * 60;
    let itemsAll = [];
    let module1 = [], module2 = [];
    let currentModule = 1;
    let iIdx = 0;
    let answers = {};
    let timerInterval = null;
    let totalTime = MODULE_SECONDS_DEFAULT;

    const app = document.getElementById('app');
    const dirReading = document.getElementById('dirReading');
    const dirWriting = document.getElementById('dirWriting');
    const moduleBreak = document.getElementById('moduleBreak');
    const container = document.getElementById('reading-container');

    const passageTitleEl = document.getElementById('passage-title');
    const passageTextEl = document.getElementById('passage-text');
    const questionContainer = document.getElementById('question-container');
    const moduleLabel = document.getElementById('moduleLabel');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const timerEl = document.getElementById('timer');
    const qCounter = document.getElementById('qCounter');

    document.addEventListener('DOMContentLoaded', () => {
      const testId = sessionStorage.getItem('SAT_TEST_ID');
      if (!testId) {
        document.body.innerHTML = "<h2 style='color:red; padding:16px;'>SAT_TEST_ID is missing. Please return to the SAT selection page.</h2>";
        return;
      }
      if (!sessionStorage.getItem('SAT_SELECTED_SECTIONS')) {
        sessionStorage.setItem('SAT_SELECTED_SECTIONS', JSON.stringify(['english']));
      }
      if (!sessionStorage.getItem('SAT_CURRENT_SECTION_INDEX')) {
        sessionStorage.setItem('SAT_CURRENT_SECTION_INDEX', '0');
      }
      const dataScript = document.createElement('script');
      dataScript.src = `data-sat/${testId}/englishData_Test${testId}.js`;
      dataScript.onload = () => {
        if (!window.satRWData || !Array.isArray(window.satRWData.items)) {
          alert("Invalid english data file (satRWData.items missing).");
          return;
        }
        itemsAll = window.satRWData.items.slice();
        module1 = itemsAll.filter(x => (x.module || 1) === 1);
        module2 = itemsAll.filter(x => x.module === 2);
        app.style.display = 'block';
        dirReading.style.display = 'block';
        attachDirectionHandlers();
      };
      dataScript.onerror = () => alert("Failed to load englishData_Test" + testId + ".js");
      document.body.appendChild(dataScript);
    });

    function attachDirectionHandlers(){
      document.getElementById('toWritingBtn').onclick = () => {
        dirReading.style.display = 'none';
        dirWriting.style.display = 'block';
      };
      document.getElementById('startEnglishBtn').onclick = () => startModule(1);
      document.getElementById('startModule2Btn').onclick = () => startModule(2);
    }

    function startModule(n){
      currentModule = n;
      iIdx = 0;
      dirWriting.style.display = 'none';
      moduleBreak.style.display = 'none';
      container.style.display = 'flex';
      moduleLabel.textContent = `SAT English — Module ${n}`;
      totalTime = (window.satRWData?.meta?.modules?.[n-1]?.timeSeconds) || MODULE_SECONDS_DEFAULT;
      startTimer();
      render();
    }

    function endModule(n){
      clearInterval(timerInterval);
      container.style.display = 'none';
      if (n === 1){
        moduleBreak.style.display = 'block';
      } else {
        finishEnglish();
      }
    }

    function startTimer(){
      updateTimer();
      timerInterval = setInterval(() => {
        totalTime--;
        if (totalTime <= 0){
          endModule(currentModule);
          return;
        }
        updateTimer();
      }, 1000);
    }

    function updateTimer(){
      const m = Math.floor(totalTime / 60);
      const s = totalTime % 60;
      timerEl.textContent = `Time Left: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function getCurrentList(){ return currentModule === 1 ? module1 : module2; }
    function getCurrentItem(){ return getCurrentList()[iIdx]; }

    function render(){
      const list = getCurrentList();
      const item = list[iIdx];
      if (!item) return;

      qCounter.textContent = `Question ${iIdx + 1} of ${list.length}`;

      passageTitleEl.textContent = item.title || "Passage";
      passageTextEl.innerHTML = buildPassageHTML(item);

      questionContainer.innerHTML = '';
      const block = document.createElement('div'); block.className = 'q-block';

      const title = document.createElement('h3'); title.className = 'q-title';
      title.textContent = item.question || "Choose the best answer.";
      const meta = document.createElement('div'); meta.className = 'q-meta';
      meta.textContent = `${item.domain || ''}${item.subtype ? ' • ' + item.subtype : ''}`;
      block.appendChild(title); block.appendChild(meta);

      const ul = document.createElement('ul'); ul.className = 'options';
      (item.options || []).forEach((opt, i) => {
        const li = document.createElement('li'); li.innerHTML = String(opt);
        const key = item.id || `${currentModule}-${iIdx+1}`;
        if (answers[key] === i) li.classList.add('selected');
        li.onclick = () => { answers[key] = i; render(); };
        ul.appendChild(li);
      });
      block.appendChild(ul);
      questionContainer.appendChild(block);

      prevBtn.disabled = iIdx === 0;
      nextBtn.textContent = iIdx === (list.length - 1) ? 'Finish Module' : 'Next';
    }

    function buildPassageHTML(item){
      if (item.passage) return String(item.passage);
      if (item.stimulusA || item.stimulusB){
        return `
          <div class="split">
            <div><strong>Text 1:</strong> ${String(item.stimulusA||'')}</div>
            <div><strong>Text 2:</strong> ${String(item.stimulusB||'')}</div>
          </div>
        `;
      }
      let html = item.stimulus ? `<p>${String(item.stimulus)}</p>` : '';
      if (item.notes && item.notes.length){
        html += `<ul>${item.notes.map(n=>`<li>${n}</li>`).join('')}</ul>`;
      }
      if (item.table){
        html += `<table class="data">
          <thead><tr>${(item.table.columns||[]).map(c=>`<th>${c}</th>`).join('')}</tr></thead>
          <tbody>${(item.table.rows||[]).map(r=>`<tr>${r.map(td=>`<td>${td}</td>`).join('')}</tr>`).join('')}</tbody>
        </table>`;
      }
      return html || "<p>(No passage)</p>";
    }

    prevBtn.onclick = () => {
      if (iIdx > 0){ iIdx--; render(); }
    };
    nextBtn.onclick = () => {
      const list = getCurrentList();
      if (iIdx < list.length - 1){ iIdx++; render(); }
      else { endModule(currentModule); }
    };

    function finishEnglish(){
      clearInterval(timerInterval);
      container.style.display = 'none';
      document.getElementById('final').style.display = 'block';

      const testId = sessionStorage.getItem('SAT_TEST_ID');
      const allItems = [...module1, ...module2];

      let score = 0;
      const details = allItems.map((it, idxAll) => {
        const key = it.id || `it-${idxAll+1}`;
        const sel = answers[key] ?? null;
        const corr = it.correct;
        const isCorrect = (typeof sel === 'number' && sel === corr);
        if (isCorrect) score++;
        return { id:key, module:(it.module||1), selected:sel, correct:corr, isCorrect };
      });

      localStorage.setItem(`result_sat_${testId}_english`, JSON.stringify({
        score, total: allItems.length, answers: details, finishedAt: new Date().toISOString()
      }));

      goToNextSATSectionOrResults();
    }

    function goToNextSATSectionOrResults(){
      const selected = JSON.parse(sessionStorage.getItem('SAT_SELECTED_SECTIONS') || '["english"]');
      let currentIndex = parseInt(sessionStorage.getItem('SAT_CURRENT_SECTION_INDEX') || '0', 10);
      currentIndex++;
      sessionStorage.setItem('SAT_CURRENT_SECTION_INDEX', String(currentIndex));

      const testId = sessionStorage.getItem('SAT_TEST_ID');
      const next = selected[currentIndex];

      if (next === 'math'){
        window.location.href = 'indexes/math.html';
      } else {
        window.open(`results-sat.html?test=${testId}`, '_blank');
      }
    }

    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      alert("Right-click is disabled on this page.");
    });
  </script>
</body>
</html>
