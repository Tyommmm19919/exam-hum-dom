<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Final Results</title>

  <style>
    :root {
      --bg: #0f1320;
      --bg-2: #101626;
      --surface: rgba(255, 255, 255, 0.06);
      --surface-strong: rgba(255, 255, 255, 0.10);
      --card: rgba(255, 255, 255, 0.12);
      --border: rgba(255, 255, 255, 0.18);

      --text: #eef3ff;
      --muted: #b8c2e6;

      --accent: #74a3ff;
      --accent-2: #66e6d2;
      --green: #35d49f;
      --blue: #4b82ff;
      --red: #ff6b7c;
      --yellow: #ffd166;

      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 18px;
      --shadow-1: 0 6px 20px rgba(0, 0, 0, .25);
      --shadow-2: 0 14px 40px rgba(0, 0, 0, .35);

      --blur: 14px;
      --speed: .25s;
      --speed-fast: .15s;

      --font: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f8fd;
        --bg-2: #eef1fb;
        --surface: rgba(255, 255, 255, .65);
        --surface-strong: rgba(255, 255, 255, .9);
        --card: rgba(255, 255, 255, .9);
        --border: rgba(23, 32, 58, .10);
        --text: #0f1428;
        --muted: #475070;
        --shadow-1: 0 8px 18px rgba(23, 32, 58, .08);
        --shadow-2: 0 18px 40px rgba(23, 32, 58, .12);
      }
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1000px 1000px at 10% -10%, #1a2240, transparent 60%),
        radial-gradient(1400px 800px at 100% 10%, #18244a, transparent 40%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      overflow-x: hidden;
      background-attachment: fixed;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(2px 2px at 10% 20%, rgba(255, 255, 255, .14) 50%, transparent 51%),
        radial-gradient(2px 2px at 70% 30%, rgba(255, 255, 255, .09) 50%, transparent 51%),
        radial-gradient(2px 2px at 30% 80%, rgba(255, 255, 255, .07) 50%, transparent 51%),
        radial-gradient(2px 2px at 80% 60%, rgba(255, 255, 255, .10) 50%, transparent 51%);
      pointer-events: none;
      opacity: .35;
    }

    /* button[onclick*="test-selection.html"]{
      position: fixed; left: 16px; top: 16px;
      background: linear-gradient(180deg, #a06bff 0%, #8553f7 100%);
      color:#fff; border:1px solid rgba(255,255,255,.25);
      border-radius: 12px; height: 44px; padding: 0 14px;
      font-weight: 800; letter-spacing:.2px; cursor: pointer;
      box-shadow: 0 10px 22px rgba(160,107,255,.22), inset 0 1px 0 rgba(255,255,255,.5);
      transition: transform var(--speed-fast), box-shadow var(--speed);
      z-index: 20;
    } */
    .topp {
      margin: auto;
      /* border: 2px solid whitesmoke; */
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(9px);
      width: min(1200px, 94%);
      height: 10vh;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    .topp button {
      min-width: 35%;
      background: linear-gradient(180deg, #35d49f, #18b98a);
      color: #041b12;
      box-shadow: 0 10px 20px rgba(24, 185, 138, .18), inset 0 1px 0 rgba(255, 255, 255, .5);
      height: 46px;
      min-width: 160px;
      padding: 0 18px;
      border: 0;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor: pointer;
      transition: transform var(--speed-fast), box-shadow var(--speed)
    }

    .topp button:hover {
      transform: translateY(-1px)
    }

    .page {
      width: min(1200px, 94%);
      margin: 10px auto 50px;
    }

    .selector {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2);
      backdrop-filter: blur(var(--blur));
      padding: 18px;
    }

    .selector h2 {
      margin: 0 0 12px 0;
      font-size: 22px;
      letter-spacing: .2px;
    }

    .selector .row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .select-wrap {
      position: relative;
    }

    .select-wrap::after {
      content: "▾";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
      font-size: 16px;
    }

    /* Style both selects the same way as your original */
    #typeSelect,
    #testSelect {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      width: 100%;
      height: 44px;
      font-size: 16px;
      color: var(--text);
      background: rgba(255, 255, 255, .08);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0 36px 0 12px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .05);
      transition: box-shadow var(--speed), border-color var(--speed);
    }

    #typeSelect:focus,
    #testSelect:focus {
      outline: none;
      border-color: rgba(116, 163, 255, .6);
      box-shadow: 0 0 0 3px rgba(116, 163, 255, .18);
    }

    option {
      color: #0f1428;
      background: #fff;
    }

    .btn-primary {
      height: 44px;
      min-width: 140px;
      background: linear-gradient(180deg, #6ea3ff 0%, var(--blue) 100%);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .25);
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(76, 130, 255, .20), inset 0 1px 0 rgba(255, 255, 255, .5);
      transition: transform var(--speed-fast), box-shadow var(--speed);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
    }

    #results {
      display: none;
      margin-top: 18px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2);
      backdrop-filter: blur(var(--blur));
      padding: 18px;
    }

    #results.show {
      display: block;
    }

    #finalResultsText {
      margin: 0 0 6px 0;
      font-size: 24px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .section-block {
      margin-top: 18px;
      background: var(--surface-strong);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-1);
      padding: 14px;
    }

    .section-block h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    .section-block p strong {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      overflow: hidden;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-1);
      table-layout: fixed;
      word-break: break-word;
    }

    th,
    td {
      padding: 12px 10px;
      border: 1px solid rgba(255, 255, 255, .10);
      text-align: center;
      background: rgba(255, 255, 255, .03);
      color: var(--text);
      font-size: 14px;
    }

    thead th {
      background: linear-gradient(180deg, rgba(116, 163, 255, .18), rgba(116, 163, 255, .10));
      font-weight: 900;
      letter-spacing: .2px;
    }

    tbody tr {
      transition: transform var(--speed-fast), box-shadow var(--speed);
    }

    tbody tr:hover {
      transform: translateY(-1px);
      box-shadow: inset 0 0 0 9999px rgba(255, 255, 255, .02);
    }

    .correct td {
      background: linear-gradient(180deg, rgba(53, 212, 159, .18), rgba(53, 212, 159, .10));
    }

    .incorrect td {
      background: linear-gradient(180deg, rgba(255, 107, 124, .18), rgba(255, 107, 124, .10));
    }

    #speaking-results audio {
      width: 100%;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, .04);
      border-radius: 10px;
      outline: none;
    }

    .muted {
      color: var(--muted);
    }

    strong {
      text-align: center;
    }

    @media (max-width: 720px) {
      .selector .row {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script src="scripts/recStore.js"></script>
</head>

<body>

  <div class="topp">
    <button onclick="window.location.href = '/index.html'"
      style="position: fixed; left: 0; z-index: 0;">Home</button>
    <button onclick="window.location.href = 'test-selection.html'" style="position: fixed; right: 0;">Test
      Selection</button>
  </div>

  <div class="page">
    <div class="selector">
      <h2>Select the test</h2>
      <div class="row">
        <div class="select-wrap">
          <select id="typeSelect">
            <option value="" selected disabled>Choose a type…</option>
            <option value="toefl">TPO</option>
            <option value="sh">SH</option>
          </select>
        </div>
        <div class="select-wrap">
          <select id="testSelect">
            <option value="" selected disabled>Choose a test…</option>
            <script>
              document.write(
                Array.from({ length: 30 }, (_, i) => `<option value="${i + 1}">Test ${i + 1}</option>`).join('')
              );
            </script>
          </select>
        </div>
        <button class="btn-primary" onclick="loadResults()">View Results</button>
      </div>
    </div>

    <div id="results">
      <h1 id="finalResultsText"></h1>
      <div id="reading-score" class="section-block"></div>
      <div id="listening-score" class="section-block"></div>
    </div>
  </div>

  <script>
    let currentTestId = null;
    let currentType = null;

    const TYPE_LABELS = { toefl: 'TOEFL', sh: 'SH' };

    function arraysEqual(a, b) {
      if (!Array.isArray(a) || !Array.isArray(b)) return false;
      if (a.length !== b.length) return false;
      const A = [...a].sort((x, y) => x - y);
      const B = [...b].sort((x, y) => x - y);
      for (let i = 0; i < A.length; i++) if (A[i] !== B[i]) return false;
      return true;
    }

    function formatAnswer(answer) {
      if (answer === null || answer === undefined) return "No answer";

      if (typeof answer === "object" && answer && "a" in answer && "b" in answer) {
        const A = Array.isArray(answer.a) && answer.a.length
          ? answer.a.map(i => String.fromCharCode(65 + i)).join(", ") : "—";
        const B = Array.isArray(answer.b) && answer.b.length
          ? answer.b.map(i => String.fromCharCode(65 + i)).join(", ") : "—";
        return `1:&nbsp; ${A} | 2:&nbsp; ${B}`;
      }

      if (Array.isArray(answer)) {
        if (answer.length === 0) return "No answer";
        return answer.map(i => typeof i === "number" ? String.fromCharCode(65 + i) : i).join(", ");
      }

      if (typeof answer === "number") return String.fromCharCode(65 + answer);
      if (typeof answer === "string") return answer;

      return String(answer);
    }

    function compareAnswers(selected, correct) {
      if (correct && typeof correct === "object" && "a" in correct && "b" in correct) {
        if (!selected || typeof selected !== "object") return false;
        const aOK = arraysEqual(selected.a || [], correct.a || []);
        const bOK = arraysEqual(selected.b || [], correct.b || []);
        return aOK && bOK;
      }
      if (Array.isArray(correct)) {
        return arraysEqual(Array.isArray(selected) ? selected : [], correct);
      }
      return selected === correct;
    }

    function getReadingData(type, testId) {
      const namespaced = localStorage.getItem(`result_${type}_${testId}_reading`);
      if (namespaced !== null) return namespaced;
      if (type === 'toefl') return localStorage.getItem(`result_${testId}_reading`);
      return null;
    }

    function getListeningData(type, testId) {
      const namespaced = localStorage.getItem(`result_${type}_${testId}_listening`);
      if (namespaced !== null) return namespaced;
      if (type === 'toefl') return localStorage.getItem(`result_${testId}_listening`);
      return null;
    }

    function getSpeakingCompleted(type, testId) {
      const namespaced = localStorage.getItem(`result_${type}_${testId}_speaking`);
      if (namespaced !== null) return namespaced;
      if (type === 'toefl') return localStorage.getItem(`result_${testId}_speaking`);
      return null;
    }

    function getWritingCompleted(type, testId) {
      const namespaced = localStorage.getItem(`result_${type}_${testId}_writing`);
      if (namespaced !== null) return namespaced;
      if (type === 'toefl') return localStorage.getItem(`result_${testId}_writing`);
      return null;
    }

    function getWrittenEssays(type, testId) {
      const namespaced = localStorage.getItem(`writtenEssays_${type}_${testId}`);
      if (namespaced !== null) return namespaced;
      if (type === 'toefl') return localStorage.getItem(`writtenEssays_${testId}`);
      return null;
    }


    function renderSection(title, data, targetId) {
      const container = document.getElementById(targetId);
      if (!container) return;

      if (!data) {
        container.innerHTML = `<h2>${title}</h2><p class="muted">You haven't written this test.</p>`;
        return;
      }

      let parsed;
      try {
        parsed = JSON.parse(data);
      } catch {
        container.innerHTML = `<h2>${title}</h2><p class="muted">No detailed answers stored.</p>`;
        return;
      }

      const { score, total, answers } = parsed;
      const percent = Math.round((score / total) * 100);

      const rows = (answers || []).map((a, i) => {
        const selectedDisplay = formatAnswer(a.selected);
        const correctDisplay = formatAnswer(a.correct);
        const isCorrect = compareAnswers(a.selected, a.correct);
        return `
          <tr class="${isCorrect ? "correct" : "incorrect"}">
            <td>${i + 1}</td>
            <td>${selectedDisplay}</td>
            <td>${correctDisplay}</td>
          </tr>`;
      }).join("");

      container.innerHTML = `
        <h2>${title}</h2>
        <p><strong>Score: ${30 - total + score}/30<br> ${score}/${total} points<br>(${percent}%) correct answers</strong></p>
        <table>
          <thead><tr><th>#</th><th>Your Answer</th><th>Correct Answer</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    async function renderSpeakingSection(type, testId) {
      const container = document.createElement("div");
      container.id = "speaking-results";
      container.className = "section-block";
      document.getElementById("results").appendChild(container);

      const isCompleted = getSpeakingCompleted(type, testId);
      if (!isCompleted) {
        container.innerHTML = `<h2>Speaking</h2><p class="muted">You haven't written this test.</p>`;
        return;
      }
      if (!window.recStore) return;

      const all = await window.recStore.listByTest(testId);
      if (!all || all.length === 0) {
        container.innerHTML = `<h2>Speaking</h2><p class="muted">No recordings found for this test.</p>`;
        return;
      }

      // Show only the 4 audios from the LAST attempt
      const hasAttempt = all.some(r => typeof r.attemptId === "number" && r.attemptId > 0);
      let latest = [];
      if (hasAttempt) {
        const latestAttempt = Math.max(...all.map(r => r.attemptId || 0));
        latest = all.filter(r => (r.attemptId || 0) === latestAttempt)
          .sort((a, b) => a.index - b.index);
      } else {
        latest = [...all].sort((a, b) => b.createdAt - a.createdAt).slice(0, 4)
          .sort((a, b) => a.index - b.index);
      }
      latest = latest.slice(0, 4);

      container.innerHTML = "<h2>Speaking</h2>";
      latest.forEach((r, i) => {
        const label = document.createElement("p");
        label.textContent = `Recording ${i + 1}`;
        const audio = document.createElement("audio");
        audio.controls = true;
        const url = URL.createObjectURL(r.blob);
        audio.src = url;
        container.appendChild(label);
        container.appendChild(audio);
      });
    }

    async function renderWritingSection(type, testId) {
      const container = document.createElement("div");
      container.id = "writing-results";
      container.className = "section-block";
      document.getElementById("results").appendChild(container);

      const isCompleted = getWritingCompleted(type, testId);
      const essaysRaw = getWrittenEssays(type, testId);
      const essays = JSON.parse(essaysRaw || "[]");

      if (!isCompleted || essays.length === 0) {
        container.innerHTML = `<h2>Writing</h2><p class="muted">You haven't written this test.</p>`;
        return;
      }

      container.innerHTML = "<h2>Writing</h2>";
      essays.forEach((essay, i) => {
        const div = document.createElement("div");
        div.style.cssText = "background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-top:10px;";
        div.innerHTML = `<h4 style="margin:0 0 6px 0;font-size:16px;font-weight:900;color:var(--muted);">${essay.label || "Essay " + (i + 1)}</h4><p style="margin:0;line-height:1.6;">${(essay.content || "").replace(/\n/g, "<br>")}</p>`;
        container.appendChild(div);
      });
    }

    function updateHeader(type, testId) {
      const label = TYPE_LABELS[type] || type?.toUpperCase() || '';
      const t = document.getElementById("finalResultsText");
      t.textContent = `${label} — Results of Test ${testId}`;
    }

    async function loadResults() {
      const tSel = document.getElementById("typeSelect").value;
      const nSel = document.getElementById("testSelect").value;
      if (!tSel || !nSel) return;

      currentType = tSel.toLowerCase();
      currentTestId = nSel;

      const resultsBlock = document.getElementById("results");
      resultsBlock.classList.add("show");

      updateHeader(currentType, currentTestId);

      document.getElementById("reading-score").innerHTML = "";
      document.getElementById("listening-score").innerHTML = "";

      const oldSpeaking = document.getElementById("speaking-results");
      if (oldSpeaking) oldSpeaking.remove();
      const oldWriting = document.getElementById("writing-results");
      if (oldWriting) oldWriting.remove();

      const readingData = getReadingData(currentType, currentTestId);
      const listeningData = getListeningData(currentType, currentTestId);

      renderSection("Reading", readingData, "reading-score");
      renderSection("Listening", listeningData, "listening-score");
      await renderSpeakingSection(currentType, currentTestId);
      await renderWritingSection(currentType, currentTestId);

      const u = new URL(location.href);
      u.searchParams.set("type", currentType);
      u.searchParams.set("test", currentTestId);
      history.replaceState(null, "", u.toString());
    }

    window.loadResults = loadResults;

    // If navigated here with ?type= & ?test=, preselect and auto-load
    document.addEventListener('DOMContentLoaded', () => {
      const qp = new URLSearchParams(location.search);
      const type = (qp.get('type') || sessionStorage.getItem('TEST_TYPE') || 'toefl').toLowerCase();
      const test = qp.get('test') || sessionStorage.getItem('TEST_ID') || '';

      const typeSel = document.getElementById('typeSelect');
      const testSel = document.getElementById('testSelect');

      if (['toefl', 'sh'].includes(type)) typeSel.value = type;
      if (test && [...testSel.options].some(o => o.value === test)) testSel.value = test;

      if (typeSel.value && testSel.value) {
        loadResults();
      }
    });
      document.addEventListener("contextmenu", (e)=> e.preventDefault());

  </script>
</body>

</html>