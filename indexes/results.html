<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Final Results</title>

  <style>
    :root {
      --bg: #0f1320;
      --bg-2: #101626;
      --surface: rgba(255, 255, 255, 0.06);
      --surface-strong: rgba(255, 255, 255, 0.10);
      --card: rgba(255, 255, 255, 0.12);
      --border: rgba(255, 255, 255, 0.18);

      --text: #eef3ff;
      --muted: #b8c2e6;

      --accent: #74a3ff;
      --accent-2: #66e6d2;
      --green: #35d49f;
      --blue: #4b82ff;
      --red: #ff6b7c;
      --yellow: #ffd166;

      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 18px;
      --shadow-1: 0 6px 20px rgba(0, 0, 0, .25);
      --shadow-2: 0 14px 40px rgba(0, 0, 0, .35);

      --blur: 14px;
      --speed: .25s;
      --speed-fast: .15s;

      --font: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f8fd;
        --bg-2: #eef1fb;
        --surface: rgba(255, 255, 255, .65);
        --surface-strong: rgba(255, 255, 255, .9);
        --card: rgba(255, 255, 255, .9);
        --border: rgba(23, 32, 58, .10);
        --text: #0f1428;
        --muted: #475070;
        --shadow-1: 0 8px 18px rgba(23, 32, 58, .08);
        --shadow-2: 0 18px 40px rgba(23, 32, 58, .12);
      }
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1000px 1000px at 10% -10%, #1a2240, transparent 60%),
        radial-gradient(1400px 800px at 100% 10%, #18244a, transparent 40%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      overflow-x: hidden;
      background-attachment: fixed;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(2px 2px at 10% 20%, rgba(255, 255, 255, .14) 50%, transparent 51%),
        radial-gradient(2px 2px at 70% 30%, rgba(255, 255, 255, .09) 50%, transparent 51%),
        radial-gradient(2px 2px at 30% 80%, rgba(255, 255, 255, .07) 50%, transparent 51%),
        radial-gradient(2px 2px at 80% 60%, rgba(255, 255, 255, .10) 50%, transparent 51%);
      pointer-events: none;
      opacity: .35;
    }

    .topp {
      margin: auto;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(9px);
      width: min(1200px, 94%);
      height: 10vh;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    .topp button {
      min-width: 35%;
      background: linear-gradient(180deg, #35d49f, #18b98a);
      color: #041b12;
      box-shadow: 0 10px 20px rgba(24, 185, 138, .18), inset 0 1px 0 rgba(255, 255, 255, .5);
      height: 46px;
      min-width: 160px;
      padding: 0 18px;
      border: 0;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor: pointer;
      transition: transform var(--speed-fast), box-shadow var(--speed)
    }

    .topp button:hover {
      transform: translateY(-1px)
    }

    .page {
      width: min(1200px, 94%);
      margin: 10px auto 50px;
    }

    .selector {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2);
      backdrop-filter: blur(var(--blur));
      padding: 18px;
    }

    .selector h2 {
      margin: 0 0 12px 0;
      font-size: 22px;
      letter-spacing: .2px;
    }

    .selector .row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .select-wrap {
      position: relative;
    }

    .select-wrap::after {
      content: "‚ñæ";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
      font-size: 16px;
    }

    #typeSelect,
    #testSelect {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      width: 100%;
      height: 44px;
      font-size: 16px;
      color: var(--text);
      background: rgba(255, 255, 255, .08);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0 36px 0 12px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .05);
      transition: box-shadow var(--speed), border-color var(--speed);
    }

    #typeSelect:focus,
    #testSelect:focus {
      outline: none;
      border-color: rgba(116, 163, 255, .6);
      box-shadow: 0 0 0 3px rgba(116, 163, 255, .18);
    }

    option {
      color: #0f1428;
      background: #fff;
    }

    .btn-primary {
      height: 44px;
      min-width: 140px;
      background: linear-gradient(180deg, #6ea3ff 0%, var(--blue) 100%);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .25);
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(76, 130, 255, .20), inset 0 1px 0 rgba(255, 255, 255, .5);
      transition: transform var(--speed-fast), box-shadow var(--speed);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
    }

    #results {
      display: none;
      margin-top: 18px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2);
      backdrop-filter: blur(var(--blur));
      padding: 18px;
    }

    #results.show {
      display: block;
    }

    #finalResultsText {
      margin: 0 0 6px 0;
      font-size: 24px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .section-block {
      margin-top: 18px;
      background: var(--surface-strong);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-1);
      padding: 14px;
    }

    .section-block h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    .section-block p strong {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      overflow: hidden;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-1);
      table-layout: fixed;
      word-break: break-word;
    }

    th,
    td {
      padding: 12px 10px;
      border: 1px solid rgba(255, 255, 255, .10);
      text-align: center;
      background: rgba(255, 255, 255, .03);
      color: var(--text);
      font-size: 14px;
    }

    thead th {
      background: linear-gradient(180deg, rgba(116, 163, 255, .18), rgba(116, 163, 255, .10));
      font-weight: 900;
      letter-spacing: .2px;
    }

    tbody tr {
      transition: transform var(--speed-fast), box-shadow var(--speed);
    }

    tbody tr:hover {
      transform: translateY(-1px);
      box-shadow: inset 0 0 0 9999px rgba(255, 255, 255, .02);
    }

    .correct td {
      background: linear-gradient(180deg, rgba(53, 212, 159, .18), rgba(53, 212, 159, .10));
    }

    .incorrect td {
      background: linear-gradient(180deg, rgba(255, 107, 124, .18), rgba(255, 107, 124, .10));
    }

    #speaking-results audio {
      width: 100%;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, .04);
      border-radius: 10px;
      outline: none;
    }

    .muted {
      color: var(--muted);
    }

    strong {
      text-align: center;
    }

    @media (max-width: 720px) {
      .selector .row {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script src="../scripts/recStore.js"></script>
</head>

<body>

  <div class="topp">
    <button onclick="window.location.href = '../index.html'" style="position: fixed; left: 0; z-index: 0;">Home</button>
    <button onclick="window.location.href = 'test-selection.html'" style="position: fixed; right: 0;">Test
      Selection</button>
  </div>

  <div class="page">
    <div class="selector">
      <h2>Select the test</h2>
      <div class="row">
        <div class="select-wrap">
          <select id="typeSelect">
            <option value="" selected disabled>Choose a type‚Ä¶</option>
            <option value="toefl">TPO</option>
            <option value="sh">SH</option>
            <option value="toefl2026">TOEFL 2026</option>
          </select>
        </div>
        <div class="select-wrap">
          <select id="testSelect">
            <option value="" selected disabled>Choose a test‚Ä¶</option>
            <script>
              document.write(
                Array.from({ length: 30 }, (_, i) => `<option value="${i + 1}">Test ${i + 1}</option>`).join('')
              );
            </script>
          </select>
        </div>
        <button class="btn-primary" onclick="loadResults()">View Results</button>
      </div>
    </div>

    <div id="results">
      <h1 id="finalResultsText"></h1>
      <div id="reading-score" class="section-block"></div>
      <div id="listening-score" class="section-block"></div>
    </div>
  </div>

  <script>
    let currentTestId = null;
    let currentType = null;

    const TYPE_LABELS = { toefl: 'TOEFL', sh: 'SH', toefl2026: 'TOEFL 2026' };

    function arraysEqual(a, b) {
      if (!Array.isArray(a) || !Array.isArray(b)) return false;
      if (a.length !== b.length) return false;
      const A = [...a].sort((x, y) => x - y);
      const B = [...b].sort((x, y) => x - y);
      for (let i = 0; i < A.length; i++) if (A[i] !== B[i]) return false;
      return true;
    }

    function formatAnswer(answer) {
      if (answer === null || answer === undefined) return "No answer";

      if (typeof answer === "object" && answer && "a" in answer && "b" in answer) {
        const A = Array.isArray(answer.a) && answer.a.length
          ? answer.a.map(i => String.fromCharCode(65 + i)).join(", ") : "‚Äî";
        const B = Array.isArray(answer.b) && answer.b.length
          ? answer.b.map(i => String.fromCharCode(65 + i)).join(", ") : "‚Äî";
        return `1:&nbsp; ${A} | 2:&nbsp; ${B}`;
      }

      if (Array.isArray(answer)) {
        if (answer.length === 0) return "No answer";
        return answer.map(i => typeof i === "number" ? String.fromCharCode(65 + i) : i).join(", ");
      }

      if (typeof answer === "number") return String.fromCharCode(65 + answer);
      if (typeof answer === "string") return answer;

      return String(answer);
    }

    function compareAnswers(selected, correct) {
      if (correct && typeof correct === "object" && "a" in correct && "b" in correct) {
        if (!selected || typeof selected !== "object") return false;
        const aOK = arraysEqual(selected.a || [], correct.a || []);
        const bOK = arraysEqual(selected.b || [], correct.b || []);
        return aOK && bOK;
      }
      if (Array.isArray(correct)) {
        return arraysEqual(Array.isArray(selected) ? selected : [], correct);
      }
      return selected === correct;
    }

    function getReadingData(type, testId) {
      const namespaced = localStorage.getItem(`result_${type}_${testId}_reading`);
      if (namespaced !== null) return namespaced;
      if (type === 'toefl') return localStorage.getItem(`result_${testId}_reading`);
      return null;
    }

    function getListeningData(type, testId) {
      const namespaced = localStorage.getItem(`result_${type}_${testId}_listening`);
      if (namespaced !== null) return namespaced;
      if (type === 'toefl') return localStorage.getItem(`result_${testId}_listening`);
      return null;
    }

    function getSpeakingCompleted(type, testId) {
      // preferred: type-namespaced
      const namespaced = localStorage.getItem(`result_${type}_${testId}_speaking`);
      if (namespaced !== null) return namespaced;

      // accept your 2026 key
      const k2026 = localStorage.getItem(`result_2026_${testId}_speaking`);
      if (k2026 !== null) return k2026;

      // legacy fallback (already used by old TOEFL)
      if (type === 'toefl' || type === 'toefl2026') {
        const legacy = localStorage.getItem(`result_${testId}_speaking`);
        if (legacy !== null) return legacy;
      }
      return null;
    }

    function getWritingCompleted(type, testId) {
      const namespaced = localStorage.getItem(`result_${type}_${testId}_writing`);
      if (namespaced !== null) return namespaced;
      // fallback for non-namespaced storage (used by older TOEFL and 2026 page)
      if (type === 'toefl' || type === 'toefl2026') {
        return localStorage.getItem(`result_${testId}_writing`);
      }
      return null;
    }

    function getWrittenEssays(type, testId) {
      const namespaced = localStorage.getItem(`writtenEssays_${type}_${testId}`);
      if (namespaced !== null) return namespaced;
      // fallback for non-namespaced storage (used by older TOEFL and 2026 page)
      if (type === 'toefl' || type === 'toefl2026') {
        return localStorage.getItem(`writtenEssays_${testId}`);
      }
      return null;
    }

    // === Writing 2026 detail is now TYPE-NAMESPACED (prevents leaking into SH/TPO) ===
    function getWriting2026Detail(type, testId) {
      // preferred: namespaced
      const keyNamespaced = `writing2026_detail_${type}_${testId}`;
      const rawN = localStorage.getItem(keyNamespaced);
      if (rawN) {
        try { return JSON.parse(rawN); } catch { return null; }
      }
      // backward-compat ONLY for real 2026 tests: accept old non-namespaced key
      if (type === 'toefl2026') {
        const rawOld = localStorage.getItem(`writing2026_detail_${testId}`);
        if (rawOld) {
          try { return JSON.parse(rawOld); } catch { return null; }
        }
      }
      return null;
    }

    function renderSection(title, data, targetId) {
      const container = document.getElementById(targetId);
      if (!container) return;

      if (!data) {
        container.innerHTML = `<h2>${title}</h2><p class="muted">You haven't written this test.</p>`;
        return;
      }

      let parsed;
      try {
        parsed = JSON.parse(data);
      } catch {
        container.innerHTML = `<h2>${title}</h2><p class="muted">No detailed answers stored.</p>`;
        return;
      }

      const { score, total, answers } = parsed;
      const percent = Math.round((score / total) * 100);

      const rows = (answers || []).map((a, i) => {
        const selectedDisplay = formatAnswer(a.selected);
        const correctDisplay = formatAnswer(a.correct);
        const isCorrect = compareAnswers(a.selected, a.correct);
        return `
        <tr class="${isCorrect ? "correct" : "incorrect"}">
          <td>${i + 1}</td>
          <td>${selectedDisplay}</td>
          <td>${correctDisplay}</td>
        </tr>`;
      }).join("");

      container.innerHTML = `
      <h2>${title}</h2>
      <p><strong>Score: ${30 - total + score}/30<br> ${score}/${total} points<br>(${percent}%) correct answers</strong></p>
      <table>
        <thead><tr><th>#</th><th>Your Answer</th><th>Correct Answer</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    async function renderSpeakingSection(type, testId) {
      const container = document.createElement("div");
      container.id = "speaking-results";
      container.className = "section-block";
      document.getElementById("results").appendChild(container);

      const isCompleted = getSpeakingCompleted(type, testId);
      if (!isCompleted) {
        container.innerHTML = `<h2>Speaking</h2><p class="muted">You haven't written this test.</p>`;
        return;
      }
      if (!window.recStore) return;

      const all = await window.recStore.listByTest(testId);
      if (!all || all.length === 0) {
        container.innerHTML = `<h2>Speaking</h2><p class="muted">No recordings found for this test.</p>`;
        return;
      }

      // Show ALL audios from the LAST attempt
      const hasAttempt = all.some(r => typeof r.attemptId === "number" && r.attemptId > 0);
      let latest = [];
      if (hasAttempt) {
        const latestAttempt = Math.max(...all.map(r => r.attemptId || 0));
        latest = all
          .filter(r => (r.attemptId || 0) === latestAttempt)
          .sort((a, b) => a.index - b.index);
      } else {
        // No attemptId present (old data) ‚Äî show everything from the most recent session heuristically
        // Group by createdAt ~ session window (fallback: just sort by index after createdAt desc)
        latest = [...all]
          .sort((a, b) => a.index - b.index);
      }


      container.innerHTML = "<h2>Speaking</h2>";
      latest.forEach((r) => {
        const label = document.createElement("p");
        label.textContent = `Recording ${(r.index ?? 0) + 1}`;
        const audio = document.createElement("audio");
        audio.controls = true;
        const url = URL.createObjectURL(r.blob);
        audio.src = url;
        container.appendChild(label);
        container.appendChild(audio);
      });

    }

    async function renderWritingSection(type, testId) {
      const container = document.createElement("div");
      container.id = "writing-results";
      container.className = "section-block";
      document.getElementById("results").appendChild(container);

      const isCompleted = getWritingCompleted(type, testId);
      const essaysRaw = getWrittenEssays(type, testId);
      const essays = JSON.parse(essaysRaw || "[]"); // for 2026 these are strings

      // üîí fetch detail strictly by type (no leaking)
      const detail = getWriting2026Detail(type, testId);  // { items:[...]} or null

      if (!isCompleted && (!essays.length && !detail)) {
        container.innerHTML = `<h2>Writing</h2><p class="muted">You haven't written this test.</p>`;
        return;
      }

      // Title
      container.innerHTML = `<h2>Writing</h2>`;

      // --- ‚¨ÜÔ∏è FIRST: Reorder detail (new type) ---
      if (detail && Array.isArray(detail.items) && detail.items.length) {
        // Mode switcher
        const switcher = document.createElement("div");
        switcher.style.cssText = "display:flex;gap:8px;margin-top:14px;align-items:center;";
        switcher.innerHTML = `
        <span class="muted">Reorder view:</span>
        <button id="w2026-mode-words" class="btn-primary" style="height:34px;min-width:120px;">By words</button>
        <button id="w2026-mode-sent"  class="btn-primary" style="height:34px;min-width:120px;">By sentence</button>
      `;
        container.appendChild(switcher);

        const block = document.createElement("div");
        container.appendChild(block);

        function renderWordsMode() {
          // Table with rows: 1.1 expected ‚Äì actual right/wrong
          const rows = [];
          detail.items.forEach((it, idx) => {
            const sn = idx + 1;
            if (!Array.isArray(it.perSlot) || !it.perSlot.length) return;
            it.perSlot.forEach((slot, j) => {
              const num = `${sn}.${j + 1}`;
              const expected = (slot?.expected ?? "").toString();
              const actual = (slot?.actual ?? "").toString();
              const ok = !!slot?.correct;
              rows.push(`
              <tr class="${ok ? "correct" : "incorrect"}">
                <td style="width:80px;">${num}</td>
                <td>${expected}</td>
                <td>${actual || "‚Äî"}</td>
                <td style="width:90px;font-weight:900;">${ok ? "right" : "wrong"}</td>
              </tr>
            `);
            });
          });
          if (!rows.length) {
            block.innerHTML = `<p class="muted" style="margin-top:10px;">No slot-level details available.</p>`;
            return;
          }
          block.innerHTML = `
          <table>
            <thead>
              <tr><th>#</th><th>Correct word</th><th>Your word</th><th>Result</th></tr>
            </thead>
            <tbody>${rows.join("")}</tbody>
          </table>
        `;
        }

        function renderSentenceMode() {
          // One panel per sentence: shows Correct and Your sentences + badge with right/wrong + score
          const parts = detail.items.map((it, idx) => {
            const ok = it.score && /^(\d+)\/(\d+)$/.test(it.score)
              ? (RegExp.$1 === RegExp.$2)  // perfect score -> "right"
              : (Array.isArray(it.perSlot) && it.perSlot.length && it.perSlot.every(s => !!s.correct));
            const badge = `<span style="
              display:inline-block;padding:4px 8px;border-radius:10px;
              border:1px solid var(--border);
              background:${ok ? 'rgba(53,212,159,.18)' : 'rgba(255,107,124,.18)'};">
              ${ok ? 'right' : 'wrong'}${it.score ? ` ‚Äì ${it.score}` : ''}
            </span>`;

            return `
            <div style="background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-top:10px;">
              <h4 style="margin:0 0 6px 0;font-size:16px;font-weight:900;color:var(--muted);">Sentence ${idx + 1} ${badge}</h4>
              <p style="margin:6px 0 4px 0;"><strong>Correct:</strong> ${(it.correctSentence || "").replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
              <p style="margin:4px 0 0 0;"><strong>Your:</strong> ${(it.finalText || "").replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
            </div>
          `;
          }).join("");
          block.innerHTML = parts || `<p class="muted" style="margin-top:10px;">No sentence-level details available.</p>`;
        }

        // default: words mode
        renderWordsMode();
        container.querySelector("#w2026-mode-words").onclick = renderWordsMode;
        container.querySelector("#w2026-mode-sent").onclick = renderSentenceMode;
      }

      // --- ‚¨áÔ∏è THEN: Essays (integrated / independent) ---
      const essayBlock = document.createElement("div");
      if (essays.length) {
        essays.forEach((entry, i) => {
          // Normalize: allow object {label,content} or plain string
          let label = `Essay ${i + 1}`;
          let text = "";
          if (entry && typeof entry === "object") {
            label = entry.label || label;
            text = (entry.content || "");
          } else {
            text = String(entry || "");
          }
          // Skip "Sentence: ..." summaries here; reorder correctness is shown above
          if (text.startsWith("Sentence:")) return;

          const div = document.createElement("div");
          div.style.cssText = "background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-top:10px;";
          div.innerHTML = `<h4 style="margin:0 0 6px 0;font-size:16px;font-weight:900;color:var(--muted);">${label}</h4>
                         <p style="margin:0;line-height:1.6;">${text.replace(/\n/g, "<br>")}</p>`;
          essayBlock.appendChild(div);
        });
      }
      if (essayBlock.childElementCount) container.appendChild(essayBlock);
    }

    function updateHeader(type, testId) {
      const label = TYPE_LABELS[type] || type?.toUpperCase() || '';
      const t = document.getElementById("finalResultsText");
      t.textContent = `${label} ‚Äî Results of Test ${testId}`;
    }

    async function loadResults() {
      const tSel = document.getElementById("typeSelect").value;
      const nSel = document.getElementById("testSelect").value;
      if (!tSel || !nSel) return;

      currentType = tSel.toLowerCase();
      currentTestId = nSel;

      const resultsBlock = document.getElementById("results");
      resultsBlock.classList.add("show");

      updateHeader(currentType, currentTestId);

      document.getElementById("reading-score").innerHTML = "";
      document.getElementById("listening-score").innerHTML = "";

      const oldSpeaking = document.getElementById("speaking-results");
      if (oldSpeaking) oldSpeaking.remove();
      const oldWriting = document.getElementById("writing-results");
      if (oldWriting) oldWriting.remove();

      const readingData = getReadingData(currentType, currentTestId);
      const listeningData = getListeningData(currentType, currentTestId);

      renderSection("Reading", readingData, "reading-score");
      renderSection("Listening", listeningData, "listening-score");
      await renderSpeakingSection(currentType, currentTestId);
      await renderWritingSection(currentType, currentTestId);

      const u = new URL(location.href);
      u.searchParams.set("type", currentType);
      u.searchParams.set("test", currentTestId);
      history.replaceState(null, "", u.toString());
    }

    window.loadResults = loadResults;

    // If navigated here with ?type= & ?test=, preselect and auto-load
    document.addEventListener('DOMContentLoaded', () => {
      const qp = new URLSearchParams(location.search);
      const type = (qp.get('type') || sessionStorage.getItem('TEST_TYPE') || 'toefl').toLowerCase();
      const test = qp.get('test') || sessionStorage.getItem('TEST_ID') || '';

      const typeSel = document.getElementById('typeSelect');
      const testSel = document.getElementById('testSelect');

      if (['toefl', 'sh', 'toefl2026'].includes(type)) typeSel.value = type;
      if (test && [...testSel.options].some(o => o.value === test)) testSel.value = test;

      if (typeSel.value && testSel.value) {
        loadResults();
      }
    });

    document.addEventListener("contextmenu", (e) => e.preventDefault());
  </script>

</body>

</html>