<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TOEFL Listening Section</title>
  <link rel="stylesheet" href="../styles/listening.css" />
  <meta name="color-scheme" content="dark">

</head>

<body>
  <p class="warning">If you leave the test, switch tabs, or close the tab, the test will automatically reset!</p>

  <div id="listening-directions">
    <audio id="listeningDirectionsAudio" src="../commonAudios/ListeningDirectionsAudio.mp3"></audio>
    <div class="topBreak">
      <button id="startListeningBtn">Continue</button>
    </div>
    <div class="directionsTextBreak">
      <h1>Listening Section Directions</h1>
      <h2>
        This test measures your ability to understand conversations and lectures in English.<br>
        The Listening section is divided into 2 separate timed parts.You will hear each conversation or lecture only one
        time.<br>
        After each conversation or lecture, you will answer some questions about it. The questions typically ask about
        the main idea and supporting details. Some questions ask about a speaker's purpose or attitude. Answer the
        questions base on what is stated or implied by the speakers.<br>
        You may take notes while you listen. You may use your notes to help you answer the questions. Your notes will
        not be scored.<br>
        In some questions, you will see this icon :This means that you will hear, but not see. part of the question.
        Some of the questions have special directions. These directions appear in a gray box on the screen.<br>
        Most questions are worth 1 point. If a question is worth more than 1 point, it will have special directions that
        indicate how many points you can receive.<br>
        You must answer each question. After you answer, click on Next.Then click on OK to confirm your answer and go on
        to the next question. After you click on OK, you cannot return to previous questions.<br>
        In an actual test or during this practice test, a clock at the top of the screen will show you how much time is
        remaining. The clock will not count down while you are listening. The clock will count down only while you are
        answering questions.<br><br>
        (Click on Continue at any time to dismiss these directions.)
      </h2>
    </div>
  </div>

  <div id="listening-section" style="display: none;">
    <div class="listeningTop">
      <div class="bb">
        <p class="mention-section" id="mention-section">Listening</p>
        <div id="timerListening">00:00</div>
      </div>
      <button id="nextBtn" disabled style="display: none;">Next</button>
      <button id="confirmBtn" style="display:none">OK</button>
    </div>

    <div id="audio-player">
      <audio id="mainAudio" hidden></audio>
      <div class="audio-progress">
        <div id="progressBar" class="audio-progress-filled"></div>
      </div>
      <!-- Mobile-friendly play button for main audio -->
      <button id="mobilePlayBtn" style="display: none; padding: 12px 24px; margin: 10px auto; background: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
        🔊 Tap to Play Audio
      </button>
    </div>

    <audio id="introAudio" hidden></audio>

    <!-- Mobile-friendly play button for intro audio -->
    <div id="introAudioContainer" style="display: none; text-align: center; margin: 10px 0;">
      <button id="mobileIntroPlayBtn" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
        🔊 Tap to Play Question Audio
      </button>
    </div>

    <div class="question-container">
      <div class="numbtext">
        <div id="question-text"></div>
      </div>
      <div class="options" id="options"></div>
    </div>
  </div>

  <div id="result" style="display:none">
    <h2>Result: <span id="score"></span>%</h2>
    <table class="result-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Your Answer</th>
          <th>Correct Answer</th>
        </tr>
      </thead>
      <tbody id="resultTable"></tbody>
    </table>
  </div>

  <script>
    window.TEST_ID = sessionStorage.getItem("TEST_ID");

    if (!window.TEST_ID) {
      document.body.innerHTML = "<h2 style='color:red;'>TEST_ID not found. Please return to the Reading section.</h2>";
      throw new Error("TEST_ID is missing in sessionStorage.");
    }

    const testNumber = window.TEST_ID;
    const dataScript = document.createElement("script");
    dataScript.src = `../data/${testNumber}/listeningData_Test${testNumber}.js`;

    dataScript.onload = () => {
      if (!window.listeningData) {
        document.body.innerHTML = "<h2 style='color:red;'>Listening data failed to load.</h2>";
        throw new Error("Listening data not loaded.");
      }

      const logicScript = document.createElement("script");
      logicScript.src = "../scripts/listening.js";

      logicScript.onload = () => {
        const audio = document.getElementById("listeningDirectionsAudio");
        const btn = document.getElementById("startListeningBtn");
        const directions = document.getElementById("listening-directions");
        const testSection = document.getElementById("listening-section");
        
        // Mobile play buttons
        const mobilePlayBtn = document.getElementById("mobilePlayBtn");
        const mobileIntroPlayBtn = document.getElementById("mobileIntroPlayBtn");
        const introAudioContainer = document.getElementById("introAudioContainer");

        const start = () => {
          directions.style.display = "none";
          testSection.style.display = "block";
          if (typeof startAllAll === "function") startAllAll();
        };

        btn.onclick = () => {
          audio.pause();
          start();
        };

        audio.onended = start;

        // Try autoplay, if it fails show mobile play button
        audio.play().catch((error) => {
          console.warn("⚠️ Directions autoplay failed:", error);
          // Show a play button for directions audio
          const directionsPlayBtn = document.createElement('button');
          directionsPlayBtn.textContent = '🔊 Tap to Play Directions';
          directionsPlayBtn.style.cssText = 'padding: 12px 24px; margin: 20px auto; background: #FF9800; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; display: block;';
          directionsPlayBtn.onclick = () => {
            audio.play().catch(e => console.error('Manual play failed:', e));
            directionsPlayBtn.style.display = 'none';
          };
          directions.querySelector('.topBreak').appendChild(directionsPlayBtn);
        });

        // Override the playIntroSequence function to handle mobile autoplay issues
        const originalPlayIntroSequence = window.playIntroSequence;
        if (originalPlayIntroSequence) {
          window.playIntroSequence = function(introList, callback) {
            introAudioContainer.style.display = 'block';
            mobileIntroPlayBtn.style.display = 'block';
            
            mobileIntroPlayBtn.onclick = () => {
              introAudioContainer.style.display = 'none';
              originalPlayIntroSequence(introList, callback);
            };
          };
        }

        // Override audio play in loadPassage to handle mobile autoplay
        const originalLoadPassage = window.loadPassage;
        if (originalLoadPassage) {
          window.loadPassage = function() {
            originalLoadPassage.apply(this, arguments);
            
            // Show mobile play button for main audio
            setTimeout(() => {
              const mainAudio = document.getElementById("mainAudio");
              if (mainAudio) {
                mobilePlayBtn.style.display = 'block';
                mobilePlayBtn.onclick = () => {
                  mainAudio.play().catch(e => {
                    console.error('Mobile play failed:', e);
                    alert('Cannot play audio. Please check your device volume and try again.');
                  });
                  mobilePlayBtn.style.display = 'none';
                };
              }
            }, 500);
          };
        }

        // Hide mobile play buttons when audio starts playing successfully
        document.addEventListener('play', function(e) {
          if (e.target.id === 'mainAudio') {
            mobilePlayBtn.style.display = 'none';
          }
          if (e.target.id === 'introAudio') {
            mobileIntroPlayBtn.style.display = 'none';
            introAudioContainer.style.display = 'none';
          }
        }, true);

      };

      document.body.appendChild(logicScript);
    };

    dataScript.onerror = () => {
      document.body.innerHTML = `<h2 style='color:red;'>Could not find listeningData_Test${testNumber}.js</h2>`;
    };

    document.body.appendChild(dataScript);
  </script>
</body>

</html>